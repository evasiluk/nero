# Модуль для Битрикс «GeoIp Api»

[Api](#api)

[Пример использования](#Пример-использования)

[Требования](#Требования)

[Контакты](#Контакты)

## Описание
Модуль предоставляет api для определения местоположения по ip-адресу. Если ip-адрес не указан явно, то местоположение определяется по текущему ip пользователя.

### В местоположение входят

* название город;
* название страны на языке сайта;
* iso-код страны
* ид страны в CMS 1С Битрикс
* название региона;
* iso-код региона;
* название район;
* ширина и долгота;
* диапазон ip-адресов.

В зависимости от выбранной службы, значения некоторых полей могут <b>отсутствовать</b> либо <b>отображаться на английском языке</b>.

### Службы определения местоположения

В обычном режиме решение предоставляет данные из первой службы, корректно вернувшей данные. Службы вызываются в порядке, указанном ниже:
* ipgeobase.ru (IpGeoBase);
* sypexgeo.net (Sypex);
* freegeoip.net (FreeGeoIp).

В случае необходимости, можно явно указать необходимую службу в 3м параметре `Location::getInstance()`.

### Кеширование
Для уменьшения количества запросов, полученная информация сохраняется в куках.

### Маркетплейс
Модуль доступен на [Маркетплейсе Битрикса](http://marketplace.1c-bitrix.ru/solutions/rover.geoip/).

## Api
### `\Rover\GeoIp\Location`
#### `public static \Rover\GeoIp\Location::getInstance($ip = null, $charset = self::CHARSET__AUTO, $service = '')`
Возвращает объект `\Rover\GeoIp\Location` для переднного ip-адреса. Если ip-адрес не передан, то объект используется текущий ip.

Вторым параметром можно передать кодировку возвращаемых данных. Если она не передана, то по умолчанию берется кодировка сайта.

Третьим параметром можно передать название предпочтительной службы.
#### `public reload($ip = null)`
Метод позволяет загрузить данные напрямую из сервисов геопозиционирования, минуя кеш.

Если параметр `$ip` не указан, то местоположение будет загружено для текущего ip-адреса.

Так же, благодаря этому методу, можно несколько раз использовать объект `\Rover\GeoIp\Location` для определения местоположения по разным ip-адресам, а не создавать каждый раз новый (см. [пример использования](#Пример-использования)).
#### `public static getCurIp()`
Возвращает ip-адрес текущего пользователя.
#### `public getData()`
Возвращает ассоциативный массив со всеми данными, которые удалось получить по ip.

	[
		'ip'            => 'xxx.xxx.xxx.xxx',
		'inetnum'       => '...',
		'country_code'  => '...',
		'country_name   => '...',
		'country_id     => '...',
		'city_name'     => '...',
		'region_name'   => '...',
		'district'      => '...',
		'lat'           => '...',
		'lng'           => '...'
	]	
	
#### `public getField($field)`	
Возвращает значние поля массива из метода `public getData()`.
	
#### `public getCity()`
Устарел, будет удалён в следующий версиях	
	
#### `public getCityName()`
Возвращает название города.	

#### `public getCountry()`
Устарел, будет удалён в следующий версиях	

#### `public getCountryCode()`
Возвращает iso-код страны.	

#### `public getCountryName()`
Возвращает название страны на текущем языке сайта.

#### `public getCountryId()`
Возвращает id страны в Битриксе.

#### `public getRegion()`
Устарел, будет удалён в следующий версиях		

#### `public getRegionName()`
Возвращает название региона.	

#### `public getRegionCode()`
Возвращает iso-код региона.	

#### `public getDistrict()`
Возвращает название района.

#### `public getLat()`
Возвращает широту.	

#### `public getLng()`
Возвращает долготу.					

#### `public getInetnum()`
Возвращает диапазон адресов, в который входит переданный ip.					

#### `public getService()`
Возвращает название geoip-сервиса, с помощью которого были получены данные
	
## Пример использования

	use Bitrix\Main\Loader,
        Rover\GeoIp\Location;

    if (Loader::includeModule('rover.geoip')){
        try{
            echo 'ваш ip: ' . Location::getCurIp() . '<br><br>'; // текущий ip
            
            $location = Location::getInstance('5.255.255.88'); // yandex.ru
            
            echo 'ip: '                 . $location->getIp() . '<br>';          // 5.255.255.88
            echo 'город: '              . $location->getCityName() . '<br>';        // Москва
            echo 'iso-код страны: '     . $location->getCountryCode() . '<br>';     // RU
            echo 'название страны: '    . $location->getCountryName() . '<br>'; // Россия
            echo 'id страны в Битриксе: '    . $location->getCountryId() . '<br>'; // 1
            echo 'регион: '             . $location->getRegionName() . '<br>';      // Москва
            echo 'iso-код региона: '    . $location->getRegionCode() . '<br>';      // 
            echo 'округ: '              . $location->getDistrict() . '<br>';    // Центральный федеральный округ
            echo 'широта: '             . $location->getLat() . '<br>';         // 55.755787
            echo 'долгота: '            . $location->getLng() . '<br>';         // 37.617634
            echo 'диапазон адресов: '   . $location->getInetnum() . '<br>';     // 5.255.252.0 - 5.255.255.255
            echo 'сервис: '             . $location->getService() . '<br><br>';     // IpGeoBase
            
            $location->reload('173.194.222.94'); // google.ru
    
            echo 'ip: '                 . $location->getIp() . '<br>';          // 173.194.222.94
            echo 'город: '              . $location->getCityName() . '<br>';        // Маунтин-Вью
            echo 'iso-код страны: '     . $location->getCountryCode() . '<br>';     // US
            echo 'название страны: '    . $location->getCountryName() . '<br>'; // США
            echo 'id страны в Битриксе: '    . $location->getCountryId() . '<br>'; // 122
            echo 'регион: '             . $location->getRegionName() . '<br>';      // Калифорния
            echo 'iso-код региона: '    . $location->getRegionCode() . '<br>';      // Калифорния
            echo 'округ: '              . $location->getDistrict() . '<br>';    // US-CA
            echo 'широта: '             . $location->getLat() . '<br>';         // 37.38605
            echo 'долгота: '            . $location->getLng() . '<br>';         // -122.08385
            echo 'диапазон адресов: '   . $location->getInetnum() . '<br>';     //
            echo 'сервис: '             . $location->getService() . '<br>';     // Sypex
            
        } catch (\Exception $e) {
            echo $e->getMessage();
        }
	} else 
        echo 'Модуль GeoIp Api не установлен';
		
## Компоненты
### Указатель местоположения пользователей (geoip.user.location)
Позволяет установить местоположение для пользователей на основе данных из модуля. Местоположение определяется по ip-адресу, с которого они впервые зашли на сайт. 

Для корректной работы компонента необходимо, чтобы на сайте велся лог сессий.

Определившиеся значения отображаются в зеленой рамочке. Чтобы обновить значение, необходимо выделить галочкой соответствующую строку и нажать «Обновить».

В визуальном редакторе компонент находится по адресу `Компоненты Rover -> Служебные -> Указатель местоположения пользователей`.
#### Параметры
* PAGE_SIZE - Количество пользователей на одной странице
* CITY_FIELDS - Поля пользователя, куда следует внести информацию о городе
* STATE_FIELDS - Поля пользователя, куда следует внести информацию о регионе
* COUNTRY_FIELDS - Поля пользователя, куда следует внести информацию о стране
## Требования	
Для работы «GeoIp Api» необходим установленный на хостинге php версии 5.3 или выше и модуль CURL.
## Контакты
По всем вопросам вы можете связаться со мной по email: rover.webdev@gmail.com, либо через форму на сайте https://rover-it.me.

## Пожертвования
Если решение оказалось вам полезным, вы можете оставить пожертование

[![Donate](https://img.shields.io/badge/Donate-PayPal-green.svg)](https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=V9Y7ZLDB5X8Z6)